<!DOCTYPE html>
<html>

<head>
    <title>Register</title>
    <meta charset="utf-8">

    <!--Make website responsive-->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Bootstrap library-->
    <link rel="stylesheet" href="libraries/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">

    <!--Custom font-->
    <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed&display=swap" rel="stylesheet">

    <!--Favicon Resources-->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">

    <!--Includes for various javascript libraries-->
    <script type="text/javascript" src="libraries/jquery-3.4.1.min.js"></script>
    <script type="text/javascript" src="libraries/popper.min.js"></script>
    <script type="text/javascript" src="libraries/hashes.min.js"></script>
    <script src="loginScript.js"></script>

</head>

<body>
    <div class="container login-container">
        <div class="col-xs-2 login-form-1">
            <h1 id="logTitle">
                Factory Dashboard
            </h1>
            <h3 class="mt-4 mb-5">Register</h3>
            <div class="form-group mb-2">

                <input type="text" class="form-control" id="txtUserName" placeholder="Create Username *" name="user"
                    required><br>
                <input type="password" class="form-control" id="txtPassword" placeholder="Create Password *"
                    name="password" required><br>
                <input type="password" class="form-control" id="txtPassword2" placeholder="Repeat Password *" required
                    oninput="check(this)"><br>

                <div style="text-align:center;">
                    <input type="submit" value="Submit" class="btnRegister" onclick="registerUser()"> <br><br>
                    <input type="button" value="Back" class="btnSubmit" onclick="window.location.assign('index.html')"">
                </div>

            </div>
            <div class="alert alert-success alert-dismissible fade show collapse" role="alert" id="alertRegister">
                <strong>Register successful.</strong>
            </div>
            <div class="alert alert-danger alert-dismissible fade show collapse" role="alert" id="alertWarning">
                <strong>Caps Lock on.</strong> You should check the fields above.
            </div>
        </div>
    </div>
</body>

<script>
    //Hide alerts
    $("#alertLogin").hide();
    $('#alertWarning').hide();
    $('#alertRegister').hide();

    var input = document.getElementById("txtPassword");
    var text = document.getElementById("alertWarning");
    startListeningCaps();
    startListeningEnter();
    var users;

    //Makes an ajax call and populates the target text boxes
    $.get("/users", function (data) {
      try {
        users = data;
      } catch (Exception) {
        console.log(Exception)
      }
    });

    //Address of websocket server
    //const url = 'ws://localhost:8080';

    function check(input) {
        if (input.value != document.getElementById('txtPassword').value) {
            input.setCustomValidity('Password Must be Matching.');
        } else {
            // input is valid -- reset the error message
            input.setCustomValidity('');
        }
    }

    function registerUser() {
        var userName = $("#txtUserName").val();
        if (checkUserUnique(userName, users)) { //If desired username is unique
            var salt = generateSalt(); //Generate random salt
            var password = $("#txtPassword").val(); //Get password
            var passwordSalt = password + salt;
            var hashPass = new Hashes.MD5().hex(password + salt); //Hash password for security
            var params = {
                user: userName,
                password: hashPass,
                salt: salt,
                status: "waiting"
            };
            $.ajax({
                type: "POST",
                url: "/register",
                data: params,
                success: function(){
                    $('#alertRegister').show();
                }

            }).done(function (e) {
                console.log(e);
                $('#alertRegister').show()
            })
        }
    }

</script>