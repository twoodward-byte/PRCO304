<!DOCTYPE html>
<html>

<head>
    <title>Register</title>
    <meta charset="utf-8">

    <!--Make website responsive-->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Bootstrap library-->
    <link rel="stylesheet" href="libraries/bootstrap.min.css">

    <!--My stylesheet-->
    <link rel="stylesheet" href="style.css">

    <!--Custom font-->
    <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed&display=swap" rel="stylesheet">

    <!--Favicon Resources-->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">

    <!--Includes for various javascript libraries-->
    <script type="text/javascript" src="libraries/jquery-3.4.1.min.js"></script>
    <script type="text/javascript" src="libraries/popper.min.js"></script>
    <script type="text/javascript" src="libraries/hashes.min.js"></script>
    <script src="libraries/loginScript.js.js"></script>

</head>

<body>
    <div class="container login-container">
        <div class="col-xs-2 login-form-1">
            <h1 id="logTitle">
                Factory Dashboard
            </h1>
            <h3 class="mt-4 mb-5">Register</h3>
            <div class="form-group mb-2">

                <input type="email" class="form-control" id="txtUserName" placeholder="Enter email address *"
                    name="user" required><br>
                <input type="password" class="form-control" id="txtPassword" placeholder="Create Password *"
                    name="password" required><br>
                <input type="password" class="form-control" id="txtPassword2" placeholder="Repeat Password *" required
                    oninput="check(this)"><br>

                <div style="text-align:center;">
                    <input type="submit" value="Submit" class="btnRegister" onclick="registerUser()"> <br><br>
                    <input type="button" value="Back" class="btnSubmit" onclick="window.location.assign('/login')"">
                </div>

            </div>

            <!--Register Success Alert-->
            <div class=" alert alert-success alert-dismissible fade show collapse" role="alert" id="alertRegister">
                    <a href="#" class="close" data-dismiss="alert" aria-label="close"
                        onclick="$('#alertRegister').hide()">&times;</a>
                    <strong>Register successful.</strong>
                </div>

                <!--Caps Lock Warning Alert-->
                <div class="alert alert-warning alert-dismissible fade show collapse" role="alert" id="alertCaps">
                    <strong>Caps Lock on.</strong> You should check the fields above.
                </div>

                <!--User not unique alert-->
                <div class="alert alert-danger alert-dismissible fade show collapse" role="alert" id="alertUnique">
                    <a href="#" class="close" data-dismiss="alert" aria-label="close"
                        onclick="$('#alertUnique').hide()">&times;</a>
                    <strong>Username already taken</strong> Please enter a different one
                </div>

                <!--Email not valid alert-->
                <div class="alert alert-danger alert-dismissible fade show collapse" role="alert" id="alertEmail">
                    <a href="#" class="close" data-dismiss="alert" aria-label="close"
                        onclick="$('#alertEmail').hide()">&times;</a>
                    <strong>Email not valid</strong> Please check again
                </div>

                <!--Passwords not matching alert-->
                <div class="alert alert-danger alert-dismissible fade show collapse" role="alert" id="alertPassword">
                    <a href="#" class="close" data-dismiss="alert" aria-label="close"
                        onclick="$('#alertPassword').hide()">&times;</a>
                    <strong>Passwords do not match</strong> Check again
                </div>


            </div>
        </div>
</body>

<script>
    var input = document.getElementById("txtPassword");
    var text = document.getElementById("alertWarning");
    var users;

    //Hide alerts
    function hideAlerts() {
        $("#alertLogin").hide();
        $('#alertCaps').hide();
        $('#alertRegister').hide();
        $('#alertUnique').hide();
        $('#alertEmail').hide();
        $('#alertPassword').hide();
    }

    hideAlerts();

    function check(input) {
        if (input.value != document.getElementById('txtPassword').value) {
            input.setCustomValidity('Password Must be Matching.');
        } else {
            // input is valid -- reset the error message
            input.setCustomValidity('');
        }
    }

    //Returns true if parameter is a valid email
    function validateEmail(email) {
        var re = /\S+@\S+\.\S+/;
        return re.test(email);
    }

    function resetInputFields() {
        $('#txtUserName').val("");
        $('#txtPassword').val("");
        $('#txtPassword2').val("");
    }

    //Returns true if parameters match
    function passwordMatch(password1, password2) {
        if (password1 == password2) {
            return true;
        }
        else {
            return false;
        }
    }

    function registerUser() {
        if (validateEmail(userName)) { //If email valid
            if (passwordMatch($('#txtPassword').val(), $('#txtPassword2').val())) { //If passwords match
                var params = {
                    user: $("#txtUserName").val(),
                    password: $("#txtPassword").val(),
                    status: "waiting"
                };
                $.ajax({
                    type: "POST",
                    url: "/register2",
                    data: params,
                    success: function (data) {
                        resetInputFields();
                        if (data.unique == false) {
                            $('#alertUnique').show();
                        }
                        if (data.success == true) {
                            $('#alertRegister').show();
                        }
                    }
                }).done(function (e) {
                })
                //}
            }
            else { $('#alertPassword').show(); } //Passwords don't match
        }
        else { //Email not valid
            $('#alertEmail').show();
        }

    }

    function startListeningEnter() {
        var input = document.getElementById("txtPassword2");
        // Execute a function when the user releases a key on the keyboard
        input.addEventListener("keyup", function (event) {
            // Number 13 is the "Enter" key on the keyboard
            if (event.keyCode === 13) {
                // Cancel the default action, if needed
                event.preventDefault();
                // Trigger the button element with a click
                registerUser();
            }
        });
    }

    function startListeningCaps(element) {
        var text = document.getElementById("alertCaps");
        element.addEventListener("keyup", function (event) {
            if (event.getModifierState("CapsLock")) {
                text.style.display = "block";
                console.log("hello");
            } else {
                text.style.display = "none"
            }
        });
    }

    startListeningCaps(document.getElementById("txtPassword2"));
    startListeningCaps(document.getElementById("txtPassword"));
    startListeningEnter();
</script>