<!DOCTYPE html>
<html>

<head>
  <!--Jquery library-->
  <script src="libraries/jquery-3.4.1.min.js"></script>

  <!--Bootstrap CSS CDN-->
  <link rel="stylesheet" href="libraries/bootstrap.min.css">

  <!--Custom font-->
  <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed&display=swap" rel="stylesheet">

  <script src="script.js"></script>

  <!--My stylesheet-->
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <h1 style="float:left" class="ml-3">
    <img class="mb-2" src="/icons/baseline_work_black_18dp.png" width="30" height="30" alt="">
    Manage Users</h1>
  <a style="position:relative;float:right;text-align: right; margin-top: 10px; z-index: 1000;" class="nav-link" href="#"
    onclick="logout()">Logout</a>

  <div style="clear:both;"></div>
  <div id="navDiv"></div>
<h2><span class="badge badge-warning ml-1">Waiting for Approval</span></h2>
  <div class="table-responsive container-fluid mr-0 pl-0 pr-0" style="width:99.9999%">
    <!--Main table-->
    <table style="width:inherit" class="table table-striped table-bordered table-hover table-dark mr-0 pr-0"
      id="itemTable">
      <tr>
        <th>User</th>
        <th>Status </th>

        <th class="table-responsive">Actions<button
            style="position: relative; right: 0px; padding: 0px 0px; margin: 0px 0px;" class="btn btn-success ml-1"
            onclick="refreshPage()">Refresh</button></th>
      </tr>
    </table>
  </div>
  <h2><span class="badge badge-primary ml-1">All Users</span></h2>
  <div class="table-responsive container-fluid mr-0 pl-0 pr-0" style="width:99.9999%">
  <table style="width:inherit" class="table table-striped table-bordered table-hover table-dark mr-0 pr-0"
  id="allUsersTable">
  <tr>
    <th>User</th>
    <th>Status </th>

    <th class="table-responsive">Actions<button
        style="position: relative; right: 0px; padding: 0px 0px; margin: 0px 0px;" class="btn btn-success ml-1"
        onclick="refreshPage()">Refresh</button></th>
  </table>
  </div>

  <div class="alert alert-success alert-dismissible fade show collapse" role="alert" id="alertApprove">
    <strong>User approved</strong>
  </div>
  <div class="alert alert-danger alert-dismissible fade show collapse" role="alert" id="alertDelete">
    <strong>User deleted</strong>
  </div>



  <script>
    var users;
    checkIfLoggedIn();

    jQuery(document).ready(function () {
      loadNavbar();
      hideAlerts();
      sendUsersRequest();
    });

    function hideAlerts(){
      $('#alertApprove').hide();
      $('#alertDelete').hide();
    }

    //Approves the user with the specified ID
    function approveBtn(id, index) {
      var params = {
        id: id,
        status: "approved"
      }
      $.ajax({
        type: "POST",
        url: "/approve",
        data: params,
        success: function () {
          $('#alertApprove').show();
          var table = document.getElementById('itemTable');
          table.deleteRow(parseInt(index));
        },
        error: function () {
          console.log("error");
        },
      });
    }

    //Deletes record with specified id and index
    function deleteBtn(id, index) {
      var params = {
        id: id
      }
      $.ajax({
        type: "POST",
        url: '/delete',
        data: params,
        success: function () { 
          $('#alertDelete').show();
          //Now refresh table UI
          var table = document.getElementById('itemTable');
          table.deleteRow(parseInt(index));
          //sleep(500);
          //window.location.reload();
        },
      }).done(function (e) {
        console.log(e);
      })
    }

    function refreshPage() {
      document.location.reload();
    }

    //Fills the table with the users data
    function fillTable(users) {
      var apprTable = document.getElementById('itemTable');
      $('#itemTable tr:gt(0)').remove()
      var i;
      var iterator = 0;
      users.forEach(function (object) {
        if(object.status == "waiting"){

      
        iterator++;
        var tr = document.createElement('tr');
        var i = object._id;
        var i = i.toString();
        iterator = iterator.toString(); 
        tr.innerHTML =
          //Item description
          '<td>' + object.user + '</td>'
          + '<td>' + object.status + ' </td>' + '<td>'
          + `<button class='btn btn-success ml-1' style='position: relative; right: 0px; padding: 0px 0px; margin: 0px 0px;' onclick='approveBtn(\"${i}\", \"${iterator}\")'>Approve</button><button class='btn btn-danger ml-1' onclick='deleteBtn(\"${i}\", \"${iterator}\")' style='position: relative; right: 0px; padding: 0px 0px;'>Delete</button></td>`
        +'</td>';
        apprTable.appendChild(tr);
          }
      });
    }

        //Fills the table with the users data
        function fillTableAllUsers(users) {
      var apprTable = document.getElementById('allUsersTable');
      $('#allUsersTable tr:gt(0)').remove()
      var i;
      var iterator = 0;
      users.forEach(function (object) {
        iterator++;
        var tr = document.createElement('tr');
        var i = object._id;
        var i = i.toString();
        iterator = iterator.toString(); 
        tr.innerHTML =
          //Item description
          '<td>' + object.user + '</td>'
          + '<td>' + object.status + ' </td>' + '<td>'
          + `<button class='btn btn-success ml-1' style='position: relative; right: 0px; padding: 0px 0px; margin: 0px 0px;' onclick='approveBtn(\"${i}\", \"${iterator}\")'>Approve</button><button class='btn btn-danger ml-1' onclick='deleteBtn(\"${i}\", \"${iterator}\")' style='position: relative; right: 0px; padding: 0px 0px;'>Delete</button></td>`
        +'</td>';
        apprTable.appendChild(tr);
      });
    }

    //Sends request for user data and populates table with data
    function sendUsersRequest(){
      $.get("/users", function (data) {
      try {
        //console.log(data);
        users = data;
        fillTable(users)
        fillTableAllUsers(users)

      } catch (Exception) {
        console.log(Exception)
      }
    });
    }
  </script>
</body>

</html>